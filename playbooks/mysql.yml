---
# playbooks/mysql.yml
# Simple & stable: install MySQL, ensure service, create DB & user over TCP.

- name: "MySQL setup"
  hosts: lamp_servers
  become: true

  vars_prompt:
    - name: mysql_root_password
      prompt: "Enter MySQL root password"
      private: yes
    - name: mysql_app_password
      prompt: "Enter application database password"
      private: yes

  tasks:
    - name: Ensure MySQL server and driver installed
      apt:
        name:
          - mysql-server
          - python3-pymysql
        state: present
        update_cache: yes

    - name: Ensure MySQL service running
      service:
        name: mysql
        state: started
        enabled: true

    - name: Wait for MySQL on TCP 3306
      wait_for:
        host: 127.0.0.1
        port: 3306
        state: started
        timeout: 60

    - name: Create application database (TCP)
      mysql_db:
        name: "{{ mysql_database }}"
        state: present
        login_host: 127.0.0.1
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_port: 3306

    - name: Create application DB user and grant privileges (TCP)
      mysql_user:
        name: "{{ mysql_user }}"
        password: "{{ mysql_app_password }}"
        host: "localhost"
        priv: "{{ mysql_database }}.*:ALL"
        state: present
        login_host: 127.0.0.1
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_port: 3306

